# 登录功能增强说明

## 功能概述

根据用户IP地址自动检测地区，为国内用户提供微信扫码登录，为国外用户提供Google账号登录，同时保留传统的邮箱登录方式。

## 新增文件

### 1. API模块
- `app/lib/api/health.ts` - 健康检查和地区检测API
- 更新 `app/lib/api/user.ts` - 添加第三方登录API
- 更新 `app/lib/api/index.ts` - 导出新的API和类型

### 2. Hooks
- `app/hooks/useRegion.ts` - 地区检测和登录选项管理Hook

### 3. 组件
- `app/components/EnhancedLoginModal.tsx` - 增强的登录模态框组件
- 更新 `app/components/index.ts` - 导出新组件

### 4. 测试页面
- `app/test-login/page.tsx` - 登录功能测试页面

## 功能特性

### 1. 自动地区检测
- 调用 `/health` 接口获取用户IP地址和主机ID
- 根据IP地址判断用户是否在国内
- 支持内网IP检测（默认为国内）

### 2. 智能登录选项
- **国内用户**：显示微信扫码登录 + 邮箱登录
- **国外用户**：显示Google账号登录 + 邮箱登录
- **网络异常**：默认显示Google登录 + 邮箱登录

### 3. 第三方登录流程
- 微信登录：获取登录URL，打开弹窗进行扫码
- Google登录：获取登录URL，打开弹窗进行授权
- 登录成功后自动处理用户信息存储

## API接口

### 健康检查接口
```typescript
GET /health
Response: {
  status: string;
  timestamp: string;
  ip: string;
  hostId: string;
  region?: string;
  country?: string;
  isDomestic?: boolean;
}
```

### 第三方登录接口
```typescript
// 微信登录
POST /api/auth/wechat-login
Body: { code: string; state?: string; }

// Google登录
POST /api/auth/google-login
Body: { idToken: string; accessToken?: string; }

// 获取登录URL
GET /api/auth/wechat-login-url
GET /api/auth/google-login-url
Response: { url: string; state: string; }
```

## 使用方法

### 1. 在页面中使用增强登录组件
```tsx
import { EnhancedLoginModal } from '@/app/components'

// 在组件中使用
<EnhancedLoginModal
  isOpen={showLoginModal}
  onClose={() => setShowLoginModal(false)}
  onLogin={handleEmailLogin}
  onRegister={handleEmailRegister}
  onThirdPartyLogin={handleThirdPartyLogin}
  isLoading={isLoading}
/>
```

### 2. 使用地区检测Hook
```tsx
import { useRegion } from '@/app/hooks/useRegion'

const { regionInfo, isLoading, getLoginOptions } = useRegion()

// 获取登录选项
const options = getLoginOptions()
// { showWechat: boolean, showGoogle: boolean, showEmail: boolean }
```

## 测试方法

1. 访问 `/test-login` 页面进行功能测试
2. 检查浏览器控制台查看地区检测结果
3. 测试不同登录方式的UI显示

## 注意事项

1. **IP检测准确性**：当前使用简化的IP段匹配，生产环境建议使用专业的IP地理位置服务
2. **第三方登录**：需要后台实现相应的OAuth流程
3. **错误处理**：网络异常时提供降级方案
4. **安全性**：第三方登录需要验证state参数防止CSRF攻击

## 后续优化建议

1. 集成专业的IP地理位置API（如ipapi.co、ipinfo.io等）
2. 添加登录状态持久化
3. 实现登录失败重试机制
4. 添加登录方式切换动画
5. 支持更多第三方登录平台

