# 项目部署配置说明

## 1. 构建项目

### 开发环境
```bash
# 开发环境（连接 https://bz.e.gaopf.top）
pnpm start:dev

# 本地环境（连接 http://localhost:8000）
pnpm start:local
```

### 生产环境构建
```bash
# 构建静态文件
pnpm export:prod

# 构建后的文件在 out/ 目录
```

## 2. Nginx 配置

### 配置文件位置
将 `nginx.conf` 文件复制到你的 nginx 配置目录，通常位于：
- `/etc/nginx/sites-available/` (Ubuntu/Debian)
- `/etc/nginx/conf.d/` (CentOS/RHEL)

### 配置说明

1. **修改域名**：
   ```nginx
   server_name your-domain.com;  # 替换为你的实际域名
   ```

2. **修改静态文件路径**：
   ```nginx
   root /path/to/your/project/out;  # 替换为你的实际项目路径
   ```

3. **API代理**：
   - 所有 `/api/` 请求会被代理到 `https://bz.e.gaopf.top/api/`
   - 包含 CORS 头处理
   - 支持 OPTIONS 预检请求

### 完整配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 静态文件根目录
    root /var/www/image-convert/out;
    index index.html;
    
    # 处理静态资源
    location / {
        try_files $uri $uri/ /index.html;
        
        # 设置缓存头
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理到后端服务
    location /api/ {
        proxy_pass https://bz.e.gaopf.top/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 处理CORS
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
        
        # 处理预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }
    
    # 健康检查接口
    location /health {
        proxy_pass https://bz.e.gaopf.top/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 错误页面
    error_page 404 /index.html;
}
```

## 3. 部署步骤

### 1. 构建项目
```bash
# 在项目根目录执行
pnpm export:prod
```

### 2. 上传文件
将 `out/` 目录下的所有文件上传到服务器的静态文件目录，例如：
```bash
# 上传到 /var/www/image-convert/out/
scp -r out/* user@server:/var/www/image-convert/out/
```

### 3. 配置 Nginx
```bash
# 复制配置文件
sudo cp nginx.conf /etc/nginx/sites-available/image-convert

# 创建软链接
sudo ln -s /etc/nginx/sites-available/image-convert /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 nginx
sudo systemctl restart nginx
```

### 4. 验证部署
- 访问你的域名，应该能看到前端页面
- 检查浏览器开发者工具，API请求应该正常
- 测试图片转换功能

## 4. 环境变量说明

### 开发环境
- `NODE_ENV=dev`
- `NEXT_PUBLIC_API_URL=https://bz.e.gaopf.top`
- 使用 Next.js 开发服务器 + API 代理

### 本地环境
- `NODE_ENV=local`
- `NEXT_PUBLIC_API_URL=http://localhost:8000`
- 使用 Next.js 开发服务器 + API 代理

### 生产环境
- `NODE_ENV=production`
- `NEXT_PUBLIC_API_URL=https://bz.e.gaopf.top`
- 使用静态导出 + Nginx 代理

## 5. 注意事项

1. **静态导出**：生产环境使用 `output: 'export'`，生成纯静态文件
2. **API代理**：通过 Nginx 将 `/api/` 请求代理到后端服务
3. **CORS处理**：Nginx 配置中已包含 CORS 头处理
4. **缓存策略**：静态资源设置长期缓存，提高性能
5. **错误处理**：404 错误重定向到 `index.html`，支持 SPA 路由

## 6. 故障排除

### 常见问题

1. **API 请求失败**：
   - 检查 Nginx 代理配置
   - 确认后端服务 `https://bz.e.gaopf.top` 可访问
   - 查看 Nginx 错误日志：`sudo tail -f /var/log/nginx/error.log`

2. **静态文件 404**：
   - 确认文件路径正确
   - 检查文件权限
   - 验证 Nginx 配置语法：`sudo nginx -t`

3. **CORS 错误**：
   - 检查 Nginx CORS 头配置
   - 确认 OPTIONS 请求处理

### 调试命令
```bash
# 检查 Nginx 配置
sudo nginx -t

# 查看 Nginx 状态
sudo systemctl status nginx

# 查看访问日志
sudo tail -f /var/log/nginx/access.log

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```
